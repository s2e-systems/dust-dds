name: OMG interoperability

on:
  workflow_dispatch:

jobs:
  create_bin_release:
    name: Create binary release
    runs-on: ubuntu-latest
    steps:
    - name: Checkout sources
      uses: actions/checkout@v4

    - uses: dtolnay/rust-toolchain@stable
    - run: cargo build --package dust_dds_shape_main_linux --release
    - name: Install tomlq
      run: cargo install tomlq
    - name: Install zip
      run: sudo apt-get install zip -y
    - name: Rename executable
      run: |
        version=$( tq -f dds/Cargo.toml 'package.version' | tr -d '"' )
        cp ./target/release/dust_dds_shape_main_linux ./dust_dds-${version}_shape_main_linux
        mkdir artifacts
        zip --junk-paths artifacts/dust_dds-${version}_shape_main_linux.zip ./dust_dds-${version}_shape_main_linux
    - name: Upload executable artifact
      uses: actions/upload-artifact@v4
      with:
        name: interoperability_executable
        path: ./artifacts/

  run_tests:
    runs-on: ubuntu-latest
    needs: create_bin_release
    strategy:
      matrix:
        publisher:
        - dust_dds-*_shape_main_linux
        - connext_dds-*_shape_main_linux
        subscriber:
        - dust_dds-*_shape_main_linux
        - connext_dds-*_shape_main_linux
    steps:
    - name: Checkout sources
      uses: actions/checkout@v4
    - uses: dtolnay/rust-toolchain@stable
    - run: cargo build --package dust_dds_shape_main_linux --release
    - name: Checkout dds-rtps
      uses: actions/checkout@v4
      with:
        repository: omg-dds/dds-rtps
        ref: '9e1fdbcd30bc785e5e5113a94e5e936695a3385e'
        path: omg-dds-rtps
        sparse-checkout-cone-mode: false
        sparse-checkout: |
          interoperability_report.py
          test_suite.py
          rtps_test_utilities.py
          requirements.txt
    - uses: actions/setup-python@v5
      with:
        python-version: '3.11.4'
    - name: Downloads shape_main executables from OMG
      uses: robinraju/release-downloader@v1.10
      with:
        repository: omg-dds/dds-rtps
        latest: true
        preRelease: true
        fileName: "*"
    - name: Download dust_dds_shape_main executable artifact from create_bin_release
      uses: actions/download-artifact@v4
      with:
        name: interoperability_executable
    - name: Unzip executables
      run: unzip '*.zip' -d executables
    - name: Setting up environment
      run: pip install -r omg-dds-rtps/requirements.txt
    - name: Run Interoperability script
      run: python3 ./omg-dds-rtps/interoperability_report.py --publisher ./executables/${{ matrix.publisher }} --subscriber ./executables/${{ matrix.subscriber }} --output-name junit_interoperability_report.xml
    - name: Upload report
      uses: actions/upload-artifact@v4
      with:
        name: "${{ matrix.publisher }}${{ matrix.subscriber }}"
        path: ./junit_interoperability_report.xml

  report:
    runs-on: ubuntu-latest
    needs: run_tests
    steps:
    - name: XUnit
      uses: AutoModality/action-xunit-viewer@v1
      with:
        results: ./report.xml
        fail: false
    - name: Upload report
      uses: actions/upload-artifact@v4
      with:
        name: interoperability_report
        path: ./index.html
